name: Build and Deploy to Azure dev environment

# When this action will be executed
on:
  # Automatically trigger it when detected changes in repo
  push:
    branches: [knowledgebot]

  # Allow manual workflow trigger
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: "Development"

    steps:
      - name: üå± Checkout to the branch
        uses: actions/checkout@v3

      - name: üçè Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"

      - name: Install azd
        uses: Azure/setup-azd@v0.1.0

      - name: üóùÔ∏è Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Package and deploy to Azure dev
        run: azd up --no-prompt
        env:
          AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
          AZURE_OPENAI_API_INSTANCE_NAME: ${{ vars.AZURE_OPENAI_API_INSTANCE_NAME }}
          ADMIN_EMAIL_ADDRESS: ${{ vars.AZURE_EADMIN_EMAIL_ADDRESSNV_NAME }}
          AUTH_ROLE: ${{ vars.AUTH_ROLE }}
          AZURE_AD_CLIENT_ID: ${{ vars.AZURE_AD_CLIENT_ID }}
          NEXTAUTH_URL: ${{ vars.NEXTAUTH_URL }}
          AZURE_AD_TENANT_ID: ${{ vars.AZURE_AD_TENANT_ID }}

          AZURE_AD_CLIENT_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
